<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>User Diagnostics</title>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 20px; background:#f7f7f8; }
    h1 { margin: 0 0 8px; }
    .muted { color:#666; }
    .card { background:#fff; border:1px solid #ddd; border-radius:12px; padding:14px; margin: 12px 0; }
    .row { display:flex; gap:18px; flex-wrap:wrap; }
    .kv { min-width: 220px; }
    .k { font-weight:700; font-size: 12px; color:#444; text-transform:uppercase; letter-spacing:.06em; }
    .v { margin-top:4px; word-break: break-word; }
    pre { background:#f2f2f3; padding:12px; border-radius:10px; overflow:auto; font-size: 13px; }
    .status { font-weight:800; }
    .ok { color: #0a7a2f; }
    .bad { color: #b00020; }
    button { padding:8px 12px; border-radius:10px; border:1px solid #ccc; background:#fff; cursor:pointer; font-weight:700; }
    button:hover { background:#f0f0f2; }
    .actions { display:flex; gap:10px; flex-wrap:wrap; }
    code { background:#eee; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>

  <h1>User Diagnostics</h1>
  <div class="muted">
    Calls <code>/auth/user/me</code> and <code>/auth/user/apps</code>.
  </div>

  <div class="card">
    <div class="row">
      <div class="kv">
        <div class="k">Location</div>
        <div class="v" id="location"></div>
      </div>
      <div class="kv">
        <div class="k">Origin</div>
        <div class="v" id="origin"></div>
      </div>
      <div class="kv">
        <div class="k">Protocol</div>
        <div class="v" id="protocol"></div>
      </div>
    </div>

    <div style="margin-top:12px;">
      <div class="k">document.cookie (JS-visible cookies only)</div>
      <pre id="cookies">(loading)</pre>
      <div class="muted">
        <code>session_id</code> is HttpOnly and will not appear here.
      </div>
    </div>
  </div>

  <div class="card">
    <div class="row" style="align-items:center; justify-content:space-between;">
      <h3 style="margin:0;">GET /auth/user/me</h3>
      <div id="meStatus" class="status"></div>
    </div>
    <pre id="meBody">(loading)</pre>
  </div>

  <div class="card">
    <div class="row" style="align-items:center; justify-content:space-between;">
      <h3 style="margin:0;">GET /auth/user/apps</h3>
      <div id="appsStatus" class="status"></div>
    </div>
    <pre id="appsBody">(loading)</pre>
  </div>

  <div class="card">
    <div class="actions">
      <button id="btnReload" type="button">Reload</button>
      <button id="btnLogin" type="button">Login</button>
      <button id="btnLogout" type="button">Logout</button>
    </div>
  </div>

<script>
"use strict";

const API_BASE = "";

function $(id) { return document.getElementById(id); }

function setStatus(el, status, ok) {
  el.textContent = String(status);
  el.classList.remove("ok", "bad");
  el.classList.add(ok ? "ok" : "bad");
}

async function fetchText(path, opts = {}) {
  const res = await fetch(API_BASE + path, {
    method: opts.method || "GET",
    headers: opts.headers || { "accept": "application/json" },
    body: opts.body,
    credentials: "include",
  });

  const text = await res.text().catch(() => "");
  return { res, text };
}

function pretty(text) {
  try { return JSON.stringify(JSON.parse(text), null, 2); }
  catch { return text || "(empty)"; }
}

async function load() {
  $("location").textContent = window.location.href;
  $("origin").textContent = window.location.origin;
  $("protocol").textContent = window.location.protocol;
  $("cookies").textContent = document.cookie || "(none visible to JS)";

  const me = await fetchText("/auth/user/me");
  setStatus($("meStatus"), me.res.status, me.res.ok);
  $("meBody").textContent = pretty(me.text);

  const apps = await fetchText("/auth/user/apps");
  setStatus($("appsStatus"), apps.res.status, apps.res.ok);
  $("appsBody").textContent = pretty(apps.text);
}

async function logout() {
  const out = await fetchText("/auth/user/logout", {
    method: "POST",
    headers: { "content-type": "application/json" },
    body: "{}"
  });

  alert(`Logout returned HTTP ${out.res.status}`);
  await load();
}

document.addEventListener("DOMContentLoaded", () => {
  $("btnReload").addEventListener("click", load);
  $("btnLogout").addEventListener("click", logout);
  $("btnLogin").addEventListener("click", () => {
    window.location.href = "login.html";
  });
  load();
});
</script>

</body>
</html>